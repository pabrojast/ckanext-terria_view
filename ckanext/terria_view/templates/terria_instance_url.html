{% import 'macros/form.html' as form %}

<style>
.hidden {
  display: none !important;
}
</style>

{{ form.input('terria_instance_url',
              label=_('URL of TerriaJS Instance'),
              value=data.terria_instance_url,
              placeholder=_('e.g. //ihp-wins.unesco.org/terria/'),
              error=errors.terria_instance_url,
              classes=['control-full', 'control-large']) }}

{# Custom configuration field with clearer options #}
<div class="control-group">
  <label class="control-label" for="custom_config_option">{{ _('Configuration Type') }}</label>
  <div class="controls">
    
    {# Automatic option (default) #}
    <div style="margin-bottom: 8px;">
      <label class="radio">
        <input type="radio" name="custom_config_option" value="automatic"
               {% if not data.custom_config or data.custom_config == 'NA' %}checked{% endif %}>
        <strong>{{ _('Automatic Configuration') }}</strong> ({{ _('Recommended') }})
        <br><small style="color: #666; margin-left: 20px;">
          {{ _('The system will automatically generate the best TerriaJS configuration based on your data format and properties.') }}
        </small>
      </label>
    </div>
    
    {# Custom configuration option #}
    <div style="margin-bottom: 8px;">
      <label class="radio">
        <input type="radio" name="custom_config_option" value="custom"
               {% if data.custom_config and data.custom_config != 'NA' %}checked{% endif %}>
        <strong>{{ _('Custom TerriaJS Configuration') }}</strong>
        <br><small style="color: #666; margin-left: 20px;">
          {{ _('Provide a custom TerriaJS URL with configuration. The system will process this URL and adapt it to your data.') }}
        </small>
      </label>
    </div>
    
    {# Input field for custom configuration #}
    {% set show_custom_input = data.custom_config and data.custom_config != 'NA' %}
    <div id="custom-config-input" class="{% if not show_custom_input %}hidden{% endif %}" style="margin-top: 10px;">
      <input type="text" id="custom-config-url" name="custom_config_url" 
             value="{% if data.custom_config and data.custom_config != 'NA' %}{{ data.custom_config }}{% endif %}"
             placeholder="{{ _('e.g. https://ihp-wins.unesco.org/terria/#share=g-abc123 or https://example.com/terria/#start=...') }}"
             class="control-full control-large" />
      <small style="color: #666; display: block; margin-top: 5px;">
        {{ _('Enter a TerriaJS URL containing your custom configuration. The system will extract and adapt the configuration for your data.') }}
      </small>
    </div>
    
    {# Hidden field to store final value #}
    <input type="hidden" id="custom_config" name="custom_config" 
           value="{% if data.custom_config and data.custom_config != 'NA' %}{{ data.custom_config }}{% else %}NA{% endif %}" />
  </div>
</div>

{# Style field with SLD file options #}
<div class="control-group">
  <label class="control-label" for="style">{{ _('Style') }}</label>
  <div class="controls">
    {% set available_sld_files = h.terria_get_sld_files(data.package_id) if data.package_id else [] %}
    
    {% if available_sld_files and available_sld_files|length > 0 %}
      {# Show available SLD files #}
      <div style="margin-bottom: 10px;">
        <label><strong>{{ _('Available SLD files:') }}</strong></label>
      </div>
      
      {% for sld_file in available_sld_files %}
        <div style="margin-bottom: 8px;">
          <label class="radio">
            <input type="radio" name="style_option" value="sld_file" 
                   data-sld-url="{{ sld_file.url }}"
                   {% if data.style == sld_file.url %}checked{% endif %}>
            <strong>{{ sld_file.name }}</strong>
            {% if sld_file.description %}
              <br><small style="color: #666; margin-left: 20px;">{{ sld_file.description }}</small>
            {% endif %}
          </label>
        </div>
      {% endfor %}
      
      {# Option for custom URL #}
      <div style="margin-bottom: 8px; margin-top: 15px;">
        <label class="radio">
          <input type="radio" name="style_option" value="custom_url"
                 {% if data.style and data.style != 'NA' and data.style not in available_sld_files|map(attribute='url') %}checked{% endif %}>
          {{ _('Custom URL') }}
        </label>
      </div>
      
      {# Option for no style #}
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="none"
                 {% if not data.style or data.style == 'NA' %}checked{% endif %}>
          {{ _('No style') }}
        </label>
      </div>
    {% else %}
      {# No SLD files available #}
      <div style="margin-bottom: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
        <p style="margin: 0; color: #666;">
          <i class="fa fa-info-circle"></i> 
          {{ _('No SLD files found in this dataset.') }}
        </p>
      </div>
      
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="custom_url"
                 {% if data.style and data.style != 'NA' %}checked{% endif %}>
          {{ _('Enter SLD file URL') }}
        </label>
      </div>
      
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="none"
                 {% if not data.style or data.style == 'NA' %}checked{% endif %}>
          {{ _('No style') }}
        </label>
      </div>
    {% endif %}
    
    {# Text field for custom URL #}
    {% set show_custom_url = data.style and data.style != 'NA' and (not available_sld_files or data.style not in available_sld_files|map(attribute='url')) %}
    <div id="custom-style-url" class="{% if not show_custom_url %}hidden{% endif %}" style="margin-top: 10px;">
      <input type="text" id="style-custom-input" name="style_custom_input" 
             value="{% if data.style and data.style != 'NA' %}{{ data.style }}{% endif %}"
             placeholder="{{ _('e.g. https://example.com/style.sld') }}"
             class="control-full control-large" />
    </div>
    
    {# Hidden field to store final value #}
    <input type="hidden" id="style" name="style" 
           value="{% if data.style and data.style != 'NA' %}{{ data.style }}{% else %}NA{% endif %}" />
  </div>
</div>


<div class="config-help-section" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #007cba;">
  <div style="display: flex; align-items: flex-start; gap: 10px;">
    <i class="fa fa-info-circle" style="color: #007cba; margin-top: 2px; font-size: 16px;"></i>
    <div style="flex: 1;">
      <h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">
        {{ _('How does the Custom Configuration work?') }}
      </h4>
      <p style="margin: 0 0 10px 0; color: #666; font-size: 13px; line-height: 1.4;">
        {{ _('The system processes your custom TerriaJS URL and adapts it to work with your data:') }}
      </p>
      <ul style="margin: 0; padding-left: 18px; color: #666; font-size: 13px; line-height: 1.3;">
        <li style="margin-bottom: 4px;">
          {{ _('Takes your TerriaJS URL with configuration (e.g., from a shared map)') }}
        </li>
        <li style="margin-bottom: 4px;">
          {{ _('Extracts the configuration settings (camera position, layers, styling, etc.)') }}
        </li>
        <li style="margin-bottom: 4px;">
          {{ _('Automatically replaces data URLs with your resource URL') }}
        </li>
        <li style="margin-bottom: 4px;">
          {{ _('Applies any selected SLD styling from this dataset') }}
        </li>
        <li>
          {{ _('Generates a viewer that maintains your custom settings but displays your data') }}
        </li>
      </ul>
    </div>
  </div>
  
  <div class="custom-config-help" style="margin-top: 15px; position: relative; display: inline-block;">
    <div style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #007cba; font-weight: 500;" 
         onclick="toggleExample()">
      <i class="fa fa-play-circle" id="example-icon" style="font-size: 14px;"></i>
      <span>{{ _('View step-by-step example') }}</span>
    </div>
    <div id="help-example" style="display: none; margin-top: 12px; padding: 12px; background-color: #fff; border-radius: 4px; border: 1px solid #ddd;">
      <img src="/help/custom_config.gif" alt="Custom Config Tutorial" style="width: 100%; max-width: 600px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
        {{ _('Example: Using a custom TerriaJS configuration with your data') }}
      </div>
    </div>
  </div>
</div>

<script>
function toggleExample() {
  var example = document.getElementById('help-example');
  var icon = document.getElementById('example-icon');
  
  if (example.classList.contains('hidden')) {
    example.classList.remove('hidden');
    icon.className = 'fa fa-pause-circle';
  } else {
    example.classList.add('hidden');
    icon.className = 'fa fa-play-circle';
  }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Custom configuration form elements
    var customConfigOptions = document.querySelectorAll('input[name="custom_config_option"]');
    var customConfigInputDiv = document.getElementById('custom-config-input');
    var customConfigUrlInput = document.getElementById('custom-config-url');
    var customConfigHidden = document.getElementById('custom_config');
    
    // Style form elements
    var styleOptions = document.querySelectorAll('input[name="style_option"]');
    var customUrlDiv = document.getElementById('custom-style-url');
    var styleCustomInput = document.getElementById('style-custom-input');
    var styleHidden = document.getElementById('style');
    
    // Function to update custom configuration field
    function updateCustomConfigField() {
        var selectedOption = document.querySelector('input[name="custom_config_option"]:checked');
        
        if (!selectedOption) return;
        
        if (selectedOption.value === 'automatic') {
            // Automatic configuration
            customConfigHidden.value = 'NA';
            customConfigInputDiv.classList.add('hidden'); // Use classList.add/remove
        } else if (selectedOption.value === 'custom') {
            // Custom configuration
            customConfigInputDiv.classList.remove('hidden'); // Use classList.add/remove
            customConfigHidden.value = customConfigUrlInput.value || 'NA';
        }
    }
    
    // Function to update style field
    function updateStyleField() {
        var selectedOption = document.querySelector('input[name="style_option"]:checked');
        
        if (!selectedOption) return;
        
        if (selectedOption.value === 'sld_file') {
            // SLD file selected
            var sldUrl = selectedOption.getAttribute('data-sld-url');
            styleHidden.value = sldUrl;
            customUrlDiv.classList.add('hidden');
        } else if (selectedOption.value === 'custom_url') {
            // Custom URL
            customUrlDiv.classList.remove('hidden');
            styleHidden.value = styleCustomInput.value || 'NA';
        } else {
            // No style
            styleHidden.value = 'NA';
            customUrlDiv.classList.add('hidden');
        }
    }
    
    // Event listeners for custom configuration
    customConfigOptions.forEach(function(option) {
        option.addEventListener('change', updateCustomConfigField);
    });
    
    // Event listener for custom configuration text field
    if (customConfigUrlInput) {
        customConfigUrlInput.addEventListener('input', function() {
            var customRadio = document.querySelector('input[name="custom_config_option"][value="custom"]');
            if (customRadio && customRadio.checked) {
                customConfigHidden.value = this.value || 'NA';
            }
        });
    }
    
    // Event listeners for style options
    styleOptions.forEach(function(option) {
        option.addEventListener('change', updateStyleField);
    });
    
    // Event listener for custom style text field
    if (styleCustomInput) {
        styleCustomInput.addEventListener('input', function() {
            var customRadio = document.querySelector('input[name="style_option"][value="custom_url"]');
            if (customRadio && customRadio.checked) {
                styleHidden.value = this.value || 'NA';
            }
        });
    }
    
    // Initialize states
    updateCustomConfigField();
    updateStyleField();
});
</script>
