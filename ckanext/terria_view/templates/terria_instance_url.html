{% import 'macros/form.html' as form %}

{# Obtener archivos SLD directamente en el template #}
{% set sld_files = [] %}
{% if data.package_id %}
  {% set package_data = h.call_action('package_show', {'id': data.package_id}) %}
  {% for resource in package_data.resources %}
    {% if resource.format and resource.format.lower() == 'sld' %}
      {% do sld_files.append({
        'id': resource.id,
        'name': resource.name or 'SLD file',
        'url': resource.url,
        'description': resource.description or ''
      }) %}
    {% endif %}
  {% endfor %}
{% endif %}

{{ form.input('terria_instance_url',
              label=_('URL of TerriaJS Instance'),
              value=data.terria_instance_url,
              placeholder=_('e.g. //ihp-wins.unesco.org/terria/'),
              error=errors.terria_instance_url,
              classes=['control-full', 'control-large']) }}

{{ form.input('custom_config',
              label=_('Custom Config'),
              value=data.custom_config,
              placeholder=_('e.g. //ihp-wins.unesco.org/terria/'),
              error=errors.custom_config,
              classes=['control-full', 'control-large']) }}

{# Campo de estilo con opciones de archivos SLD #}
<div class="control-group">
  <label class="control-label" for="style">{{ _('Style') }}</label>
  <div class="controls">
    {# DEBUG: Mostrar informaci贸n de debugging #}
    {% if True %}
      {% set sld_files_helper = h.terria_get_sld_files(data.package_id) if data.package_id else [] %}
      
      <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc;">
        <strong>DEBUG INFO:</strong><br>
        Available SLD files count (original): {{ data.available_sld_files|length if data.available_sld_files else 'None' }}<br>
        Available SLD files count (helper): {{ sld_files_helper|length }}<br>
        Data keys: {{ data.keys()|list }}<br>
        Package ID: {{ data.package_id or 'None' }}<br>
        {% if sld_files_helper %}
          SLD files (helper): 
          {% for sld in sld_files_helper %}
            <br>- {{ sld.name }} ({{ sld.url }})
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}
    
    {% set available_sld_files = h.terria_get_sld_files(data.package_id) if data.package_id else [] %}
    
    {% if available_sld_files and available_sld_files|length > 0 %}
      {# Mostrar archivos SLD disponibles #}
      <div style="margin-bottom: 10px;">
        <label><strong>{{ _('Available SLD files:') }}</strong></label>
      </div>
      
      {% for sld_file in available_sld_files %}
        <div style="margin-bottom: 8px;">
          <label class="radio">
            <input type="radio" name="style_option" value="sld_file" 
                   data-sld-url="{{ sld_file.url }}"
                   {% if data.style == sld_file.url %}checked{% endif %}>
            <strong>{{ sld_file.name }}</strong>
            {% if sld_file.description %}
              <br><small style="color: #666; margin-left: 20px;">{{ sld_file.description }}</small>
            {% endif %}
          </label>
        </div>
      {% endfor %}
      
      {# Opci贸n para URL personalizada #}
      <div style="margin-bottom: 8px; margin-top: 15px;">
        <label class="radio">
          <input type="radio" name="style_option" value="custom_url"
                 {% if data.style and data.style != 'NA' and data.style not in available_sld_files|map(attribute='url') %}checked{% endif %}>
          {{ _('Custom URL') }}
        </label>
      </div>
      
      {# Opci贸n para sin estilo #}
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="none"
                 {% if not data.style or data.style == 'NA' %}checked{% endif %}>
          {{ _('No style') }}
        </label>
      </div>
    {% else %}
      {# No hay archivos SLD disponibles #}
      <div style="margin-bottom: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
        <p style="margin: 0; color: #666;">
          <i class="fa fa-info-circle"></i> 
          {{ _('No SLD files found in this dataset.') }}
        </p>
      </div>
      
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="custom_url"
                 {% if data.style and data.style != 'NA' %}checked{% endif %}>
          {{ _('Enter SLD file URL') }}
        </label>
      </div>
      
      <div style="margin-bottom: 8px;">
        <label class="radio">
          <input type="radio" name="style_option" value="none"
                 {% if not data.style or data.style == 'NA' %}checked{% endif %}>
          {{ _('No style') }}
        </label>
      </div>
    {% endif %}
    
    {# Campo de texto para URL personalizada #}
    <div id="custom-style-url" style="margin-top: 10px; {% if not data.style or data.style == 'NA' or (available_sld_files and data.style in available_sld_files|map(attribute='url')) %}display: none;{% endif %}">
      <input type="text" id="style-custom-input" name="style_custom_input" 
             value="{% if data.style and data.style != 'NA' %}{{ data.style }}{% endif %}"
             placeholder="{{ _('e.g. https://example.com/style.sld') }}"
             class="control-full control-large" />
    </div>
    
    {# Campo oculto para almacenar el valor final #}
    <input type="hidden" id="style" name="style" 
           value="{% if data.style and data.style != 'NA' %}{{ data.style }}{% else %}NA{% endif %}" />
  </div>
</div>



<div style="margin-bottom: 10px; position: relative; display: inline-block;">
<span style="cursor: pointer;">{{ _('Custom Config Example') }}</span>
<div class="gif-tooltip" style="visibility: hidden; width: 800px; background-color: #fff; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s;">
    <img src="/help/custom_config.gif" alt="Descripci贸n del GIF" style="width: 100%;">
</div>
</div>

<style>
.form-group + div:hover .gif-tooltip {
    visibility: visible !important;
    opacity: 1 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var styleOptions = document.querySelectorAll('input[name="style_option"]');
    var customUrlDiv = document.getElementById('custom-style-url');
    var styleCustomInput = document.getElementById('style-custom-input');
    var styleHidden = document.getElementById('style');
    
    // Function to update the style field
    function updateStyleField() {
        var selectedOption = document.querySelector('input[name="style_option"]:checked');
        
        if (!selectedOption) return;
        
        if (selectedOption.value === 'sld_file') {
            // SLD file selected
            var sldUrl = selectedOption.getAttribute('data-sld-url');
            styleHidden.value = sldUrl;
            customUrlDiv.style.display = 'none';
        } else if (selectedOption.value === 'custom_url') {
            // Custom URL
            customUrlDiv.style.display = 'block';
            styleHidden.value = styleCustomInput.value || 'NA';
        } else {
            // No style
            styleHidden.value = 'NA';
            customUrlDiv.style.display = 'none';
        }
    }
    
    // Add event listeners to radio buttons
    styleOptions.forEach(function(option) {
        option.addEventListener('change', updateStyleField);
    });
    
    // Add event listener to custom text field
    if (styleCustomInput) {
        styleCustomInput.addEventListener('input', function() {
            var customRadio = document.querySelector('input[name="style_option"][value="custom_url"]');
            if (customRadio && customRadio.checked) {
                styleHidden.value = this.value || 'NA';
            }
        });
    }
    
    // Initialize state
    updateStyleField();
});
</script>
